<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>å·¥ä½œåŒºæ–‡ä»¶</title>
  <style>
    .tree ul {
      list-style-type: none;
    }

    .tree li {
      margin: 5px 0;
    }

    .tree .file:before {
      content: 'ğŸ“„ ';
    }

    .tree .folder:before {
      content: 'ğŸ“ ';
    }
  </style>
</head>

<body>

  <h1>Main File Name</h1>
  <div id="fileName"></div>
  <span><a href="/user-project-json">json</a>
    <a href="/fetch-files">files</a></span>

  <h2>File Tree</h2>
  <div id="fileTree" class="tree"></div>

  <script>

    const hostname = window.location.hostname;
    console.log(hostname)
    const port = window.location.port ? `:${window.location.port}` : '';

    // æ„é€ å®Œæ•´çš„URL
    const fullUrl = `http://${hostname}${port}`;
    console.log('url: ', fullUrl);
    // è·å–æ–‡ä»¶å¤¹å†…å®¹

    async function fetchFolderContents () {

      const response = await fetch(`${fullUrl}/fetch-files`, {
        method: 'GET',
        credentials: 'include' // ç¡®ä¿è¯·æ±‚æºå¸¦cookie
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      const files = data.files;
      console.log("files is ", files)
      return files;
    }


    // å‡è®¾è¿™æ˜¯ä»æœåŠ¡å™¨è·å–çš„æ–‡ä»¶è·¯å¾„åˆ—è¡¨



    // æ„å»ºæ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„æ ‘å½¢ç»“æ„
    function buildTree (filePaths) {
      const tree = {};

      filePaths.forEach(path => {
        const parts = path.split('/');
        let current = tree;

        for (let i = 0; i < parts.length; i++) {
          const part = parts[i];
          if (!current[part]) {
            current[part] = {};
          }
          current = current[part];
        }
      });

      return tree;
    }

    // é€’å½’æ¸²æŸ“æ–‡ä»¶æ ‘
    function renderTree (tree, path = '') {
      const ul = document.createElement('ul');

      for (const [name, content] of Object.entries(tree)) {
        const li = document.createElement('li');
        const isFolder = typeof content === 'object' && Object.keys(content).length > 0;
        // const iconName = isFolder ? 'ğŸ“' : 'ğŸ“„';
        const finalPath = path ? `${path}/${name}` : name;

        li.className = isFolder ? 'folder' : 'file';
        // li.innerHTML = `<span>${iconName}${name}</span>`;
        li.innerHTML = `<span>${name}</span>`;
        ul.appendChild(li);

        if (isFolder) {
          const subtree = renderTree(content, finalPath);
          li.appendChild(subtree);
        }
      }

      return ul;
    }

    // æ›´æ–° UI
    async function updateUI (fileName) {
      const fileNameElement = document.getElementById('fileName');
      fileNameElement.textContent = fileName;
      const files = await fetchFolderContents();
      console.log("files is ", files)
      const tree = buildTree(files);
      const treeElement = renderTree(tree);
      document.getElementById('fileTree').appendChild(treeElement);
    }



    // é¡µé¢åŠ è½½å®Œæ¯•åæ›´æ–° UI
    // document.addEventListener('DOMContentLoaded', updateUI);
    // å‘é€ POST è¯·æ±‚åˆ°æœåŠ¡å™¨è·å– folderName
    fetch(`${fullUrl}/user-file`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
    })
      .then(response => response.json())
      .then(data => {
        updateUI(data.folderName); // ä½¿ç”¨ä»æœåŠ¡å™¨è¿”å›çš„ folderName æ›´æ–° UI
        console.log("data is ", data)
      })
      .catch(error => {
        console.error('Error:', error);
      });
  </script>
</body>

</html>